name: Create Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current source hash
        id: version
        uses: ./.github/actions/get-current-source-hash

      - name: Run build
        run: ./build.sh

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_TAG="v-${{ steps.version.outputs.current_hash }}"
          TAG_NAME="$BASE_TAG"
          INCREMENT=1

          # Find an available tag name by auto-incrementing
          while git tag | grep ${TAG_NAME} > /dev/null; do
              echo "Tag $TAG_NAME already exists. Trying next increment..."
              TAG_NAME="${BASE_TAG}-${INCREMENT}"
              INCREMENT=$((INCREMENT + 1))
          done

          echo "Using tag name: ${TAG_NAME}"
          RELEASE_TITLE="Release ${TAG_NAME}"

          # Create release body
          REPO_URL="https://github.com/aseprite/api"
          RELEASE_BODY="$(cat <<EOF
          Type definitions for Aseprite scripting API

          ## Source Information
          - Based on commit: \`${{ steps.version.outputs.current_hash }}\`
          - Source repository: ${REPO_URL}
          - View source: ${REPO_URL}/tree/${{ steps.version.outputs.current_hash }}

          ## Installation
          Download \`aseprite.lua\` and place it in your Lua language server workspace.
          EOF
          )"

          # Create draft release with artifact
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes "$RELEASE_BODY" \
            dist/aseprite.lua
